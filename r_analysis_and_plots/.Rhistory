cowplot::plot_grid(insp2, insp1, ncol=1, align="v", rel_heights = c(.35,.65))
poprep_enrich_data = instrain_reps %>% filter(is_shared) %>% left_join(meta_minimal %>% dplyr::select(iid, IBD_r) %>% distinct) %>% mutate(pr= (is_poprep_only+is_both)>0, IBD_r=as.character(IBD_r) ) %>% group_by(species, IBD_r) %>% summarise(n=n(), tot_pr = sum(pr)) %>% mutate(rel_pr = tot_pr/n) %>% filter(n>=5) %>% (function(df) df %>% left_join(df %>% group_by(species) %>% summarise(n_group=n()))) %>% filter(n_group>=2) %>% ungroup
poprep_enrich_data
pwy_tab = read_tsv("~/Downloads/meta_pwy.tbl")
pwy_tab
pwy_tab$hierarchy
pwy_tab %>% head
pwy_tab %>% dplyr::select(id, hierarchy)
pwy_tab %>% dplyr::select(id, hierarchy)
pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy)
pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy, sep = ",")
pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy, sep = ",") %>% mutate(id=gsub("[|]","",id))
pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy, sep = ",") %>% mutate(id=gsub("[|]","",id), hierarchy=gsub("[|]","",hierarchy))
pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy, sep = ",") %>% mutate(id=gsub("[|]","",id)) %>% distinct()
pwy_hierarchy = pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy, sep = ",") %>% mutate(id=gsub("[|]","",id)) %>% distinct()
pwy_res_meta
pwy_res_meta %>% filter(disease=="CD")
pwy_hierarchy_filt = pwy_hierarchy %>% filter(id %in% testvars_pwy)
testvars_pwy
pwy_names = read_tsv("MAG_data/abundance_tables/KINDRED_ITM_pathway_dictionary.tsv")
pwy_pred = read_tsv("MAG_data/abundance_tables/KINDRED_ITM_pathway_prediction.tsv")
pwy_abu = sgb_long %>% dplyr::select(sample, cluster=variable, value) %>% left_join(reshape2::melt(pwy_pred) %>% dplyr::select(cluster, pwy=variable, present=value)) %>% filter(present>0) %>%
group_by(sample, pwy) %>% summarise(value_tpm=sum(value)) %>% reshape2::dcast(sample ~ pwy, value.var="value_tpm", fill=0)
pwy_tab = read_tsv("~/Downloads/meta_pwy.tbl")
pwy_hierarchy = pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy, sep = ",") %>% mutate(id=gsub("[|]","",id)) %>% distinct()
#pwy_abu = read_tsv("MAG_data/abundance_tables/KINDRED_ITM_pathway_abundance.tsv")
pwy_abu_long = pwy_abu  %>% reshape2::melt(.) %>%
left_join(meta_minimal, by="sample") %>%
mutate(variable=as.character(variable)) %>%
mutate(IBDy= IBD %in% c("CD","UC"), IBD_CD = IBD=="CD") %>%
mutate(value_tpm=value, value = log(value_tpm+1)) %>%
filter(!is.na(IBD))
pwy_abu_stats = pwy_abu_long %>% filter(phase=="BL") %>% group_by(variable, IBD, country) %>% summarise(mean_tpm = mean(value_tpm), prev_tpm = mean(value_tpm>0)) %>% ungroup() %>% bind_rows(pwy_abu_long %>% filter(phase=="BL") %>% group_by(variable, country) %>% summarise(mean_tpm = mean(value_tpm), prev_tpm = mean(value_tpm>0)) %>% ungroup() %>% mutate(IBD="all")) %>% arrange(variable)
testvars_pwy = pwy_abu_stats %>% filter((IBD=="all" & prev_tpm>=.2) | prev_tpm>=.3) %>% pull(variable) %>% unique()
pwy_hierarchy_filt = pwy_hierarchy %>% filter(id %in% testvars_pwy)
dim(pwy_hierarchy_filt)
dim(pwy_hierarchy)
testvars_pwy
pwy_hierarchy_filt$id
pwy_hierarchy_filt$id %>% unique
meta
pwy_res_meta
pwy_res_meta %>% left_join(pwy_hierarchy_filt)
pwy_res_meta %>% left_join(pwy_hierarchy_filt, by=c("tax"="id"))
pwy_hierarchy = pwy_tab %>% dplyr::select(id, hierarchy) %>% separate_rows(hierarchy, sep = ",") %>% mutate(id=gsub("[|]","",id),hierarchy=gsub("[|]","",hierarchy)) %>% distinct()
pwy_hierarchy_filt = pwy_hierarchy %>% filter(id %in% testvars_pwy)
pwy_res_meta %>% left_join(pwy_hierarchy_filt, by=c("tax"="id"))
pwy_res_meta %>% left_join(pwy_hierarchy_filt, by=c("tax"="id")) %>% filter(hierarchy=="Vitamin-Biosynthesis")
pwy_res_meta %>% left_join(pwy_hierarchy_filt, by=c("tax"="id")) %>% filter(hierarchy=="Vitamin-Biosynthesis", disease=="CD")
pwy_hierarchy_filt
pwycat="Vitamin-Biosynthesis"
this_cat = pwy_hierarchy_filt %>% filter(hierarchy %in% pwycat)
this_cat
this_cat = pwy_hierarchy_filt %>% filter(hierarchy %in% pwycat) %>% pull(id)
this_cat
pwy_res_meta %>% filter(tax %in% this_cat)
pwy_res_meta %>% filter(disease=="CD")
pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, thiscat = tax %in% this_cat)
pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", thiscat = tax %in% this_cat)
pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat)
pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table
pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_up = pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
fisher_cd_down
fisher_cd_any
fisher_uc_up = pwy_res_meta %>% filter(disease=="UC") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_uc_down = pwy_res_meta %>% filter(disease=="UC") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_uc_any = pwy_res_meta %>% filter(disease=="UC") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
fisher_ibd_up = pwy_res_meta %>% filter(disease=="IBD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_ibd_down = pwy_res_meta %>% filter(disease=="IBD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_ibd_any = pwy_res_meta %>% filter(disease=="IBD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
fisher_uc_up
fisher_uc_down
fisher_uc_any
return(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate))
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease=="CD") %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
})
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
})
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
}) %>% do.call("bind_rows",.)
pwycat_enricht = lapply(pwy_hierarchy_filt$hierarchy %>% unique, function(pwycat){
this_cat = pwy_hierarchy_filt %>% filter(hierarchy %in% pwycat) %>% pull(id)
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
}) %>% do.call("bind_rows",.) %>% mutate(pwycat=pwycat)
}) %>% do.call("bind_rows",.)
pwycat_enricht
pwycat_enricht %>% head
pwycat_enricht %>% arrange(p_fisher)
pwycat_enricht %>% arrange(p_fisher) %>% head
pwycat_enricht %>% arrange(p_fisher) %>% view
pwycat_enricht %>% arrange(p_fisher) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% filter(p_adj < 0.05)
pwycat_enricht %>% arrange(p_fisher) %>% group_by(diseaes) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% filter(p_adj < 0.05)
pwycat_enricht %>% arrange(p_fisher) %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% filter(p_adj < 0.05)
pwycat_enricht %>% arrange(p_fisher) %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% filter(p_adj < 0.1)
pwycat_enricht %>% arrange(p_fisher) %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% filter(p_adj < 0.1) %>% view
pwycat_enricht %>% arrange(p_fisher) %>% filter(dir!="ANY") %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% filter(p_adj < 0.1) %>% view
pwycat_enricht %>% arrange(p_fisher) %>% filter(dir!="ANY") %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% filter(p_adj < 0.2) %>% view
pwycat_enricht %>% arrange(p_fisher) %>% filter(dir!="ANY") %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% view
pwy_hierarchy_filt
pwy_hierarchy_filt$hierarchy
pwy_hierarchy_filt$hierarchy %>% table
pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n())
pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5)
pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5) %>% pull(hierarchy)
pwycat_enricht = lapply(pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5) %>% pull(hierarchy), function(pwycat){
this_cat = pwy_hierarchy_filt %>% filter(hierarchy %in% pwycat) %>% pull(id)
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease==dis) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
}) %>% do.call("bind_rows",.) %>% mutate(pwycat=pwycat)
}) %>% do.call("bind_rows",.)
pwycat_enricht %>% arrange(p_fisher) %>% filter(dir!="ANY") %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% view
hier_cand = (pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5) %>% pull(hierarchy))
pwycat_enricht = lapply(hier_cand, function(pwycat){
this_cat = pwy_hierarchy_filt %>% filter(hierarchy %in% pwycat) %>% pull(id)
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease==dis, tax %in% hier_cand) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease==dis, tax %in% hier_cand) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease==dis, tax %in% hier_cand) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
}) %>% do.call("bind_rows",.) %>% mutate(pwycat=pwycat)
}) %>% do.call("bind_rows",.)
pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5)
pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5)  %>% arrangen
pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5)  %>% arrange(n)
pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5)  %>% arrange(-n)
hier_cand = (pwy_hierarchy_filt %>% group_by(hierarchy) %>% summarise(n=n()) %>% filter(n>=5, n<700) %>% pull(hierarchy))
pwycat_enricht = lapply(hier_cand, function(pwycat){
this_cat = pwy_hierarchy_filt %>% filter(hierarchy %in% pwycat) %>% pull(id)
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease==dis, tax %in% hier_cand) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease==dis, tax %in% hier_cand) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease==dis, tax %in% hier_cand) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
}) %>% do.call("bind_rows",.) %>% mutate(pwycat=pwycat)
}) %>% do.call("bind_rows",.)
hier_cand
head(pwy_hierarchy_filt)
hier_cand
pwy_hierarchy_filt = pwy_hierarchy_filt %>% filter(hierarchy %in% hier_cand)
pwy_hierarchy_filt
pwy_hierarchy_filt$id
pwy_hierarchy_filt$id %>% unique
pwycat_enricht = lapply(hier_cand, function(pwycat){
this_cat = pwy_hierarchy_filt %>% filter(hierarchy %in% pwycat) %>% pull(id)
lapply(c("CD","UC","IBD"), function(dis){
fisher_cd_up = pwy_res_meta %>% filter(disease==dis, tax %in% pwy_hierarchy_filt$id) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigup, thiscat) %>% table %>% fisher.test()
fisher_cd_down = pwy_res_meta %>% filter(disease==dis, tax %in% pwy_hierarchy_filt$id) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sigdown, thiscat) %>% table %>% fisher.test()
fisher_cd_any = pwy_res_meta %>% filter(disease==dis, tax %in% pwy_hierarchy_filt$id) %>% mutate(sig = q.value<0.05, sigup= sig & dir=="UP", sigdown = sig & dir == "DOWN", thiscat = tax %in% this_cat) %>% dplyr::select(sig, thiscat) %>% table %>% fisher.test()
return(data.frame(dis=dis, dir = c("UP","DOWN","ANY"), p_fisher = c(fisher_cd_up$p.value, fisher_cd_down$p.value, fisher_cd_any$p.value), estimate = c(fisher_cd_up$estimate, fisher_cd_down$estimate, fisher_cd_any$estimate), stringsAsFactors = F))
}) %>% do.call("bind_rows",.) %>% mutate(pwycat=pwycat)
}) %>% do.call("bind_rows",.)
pwycat_enricht %>% arrange(p_fisher) %>% filter(dir!="ANY") %>% group_by(dis) %>% mutate(p_adj = p.adjust(p_fisher, "fdr")) %>% view
pwy_abu_long
pwy_abu
pwy_abu[,1]
sgb_long %>% dplyr::select(sample, cluster=variable, value) %>% left_join(reshape2::melt(pwy_pred) %>% dplyr::select(cluster, pwy=variable, present=value))
sgb_long %>% dplyr::select(sample, cluster=variable, value) %>% left_join(reshape2::melt(pwy_pred) %>% dplyr::select(cluster, pwy=variable, present=value)) %>% filter(present>0) %>% left_join(tax2, by)
head(tax2)
sgb_long %>% dplyr::select(sample, cluster=variable, value) %>% left_join(reshape2::melt(pwy_pred) %>% dplyr::select(cluster, pwy=variable, present=value)) %>% filter(present>0) %>% left_join(tax2, by=c("cluster"="final"))
sgb_long %>% dplyr::select(sample, cluster=variable, value) %>% left_join(reshape2::melt(pwy_pred) %>% dplyr::select(cluster, pwy=variable, present=value)) %>% filter(present>0) %>% left_join(tax2, by=c("cluster"="final")) %>% dplyr::select(species,pwy) %>% distinct() %>% group_by(pwy) %>% summarise(n=n())
pwy_num_spe = sgb_long %>% dplyr::select(sample, cluster=variable, value) %>% left_join(reshape2::melt(pwy_pred) %>% dplyr::select(cluster, pwy=variable, present=value)) %>% filter(present>0) %>% left_join(tax2, by=c("cluster"="final")) %>% dplyr::select(species,pwy) %>% distinct() %>% group_by(pwy) %>% summarise(n=n())
pwy_num_spe %>% arrange(n)
pwy_num_spe %>% pull(n)
pwy_num_spe %>% pull(n) %>% table
pwy_num_spe %>% filter(n>=5)
pwy_num_spe %>% filter(n>=5) %>% pull(pwy)
pwy_num_spe %>% filter(n>=5) %>% pull(pwy) %>% as.character()
length(testvars_pwy)
testvars_pwy = pwy_abu_stats %>% filter((IBD=="all" & prev_tpm>=.2) | prev_tpm>=.3, pwy %in% (pwy_num_spe %>% filter(n>=5) %>% pull(pwy) %>% as.character())) %>% pull(variable) %>% unique()
pwy_num_spe %>% filter(n>=5) %>% pull(pwy) %>% as.character()
head(pwy_abu_stats)
testvars_pwy = pwy_abu_stats %>% filter((IBD=="all" & prev_tpm>=.2) | prev_tpm>=.3, variable %in% (pwy_num_spe %>% filter(n>=5) %>% pull(pwy) %>% as.character())) %>% pull(variable) %>% unique()
dim(testvars_pwy)
length(testvars_pwy)
pwy_res_raw = lapply(testvars_pwy, function(g){
this_data = pwy_abu_long %>% filter(variable==g)
### KIN BL
mod_kin_bl_ibd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","FC"), country=="GER") %>%
lme(value ~ age + sex + bmi + IBDy, random = ~1|family, data=.)
mod_kin_bl_cd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","FC"), country=="GER") %>%
lme(value ~ age + sex + bmi + (IBD=="CD"), random = ~1|family, data=.)
mod_kin_bl_uc = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","FC"), country=="GER") %>%
lme(value ~ age + sex + bmi + (IBD=="UC"), random = ~1|family, data=.)
### KIN F1
mod_kin_f1_ibd = this_data %>% filter(phase=="F1", IBD %in% c("CD","UC","FC"), country=="GER") %>%
lme(value ~ age + sex + bmi + IBDy, random = ~1|family, data=.)
mod_kin_f1_cd = this_data %>% filter(phase=="F1", IBD %in% c("CD","UC","FC"), country=="GER") %>%
lme(value ~ age + sex + bmi + (IBD=="CD"), random = ~1|family, data=.)
mod_kin_f1_uc = this_data %>% filter(phase=="F1", IBD %in% c("CD","UC","FC"), country=="GER") %>%
lme(value ~ age + sex + bmi + (IBD=="UC"), random = ~1|family, data=.)
### ITM BL vs IBD
mod_itm_bl_ibd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="GER") %>%
lm(value ~ age + sex + bmi + IBDy, data=.)
mod_itm_bl_cd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="GER") %>%
lm(value ~ age + sex + bmi + (IBD=="CD"), data=.)
mod_itm_bl_uc = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="GER") %>%
lm(value ~ age + sex + bmi + (IBD=="UC"), data=.)
mod_sic_bl_ibd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="SWE") %>%
lm(value ~ age + sex  + IBDy, data=.)
mod_sic_bl_cd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="SWE") %>%
lm(value ~ age + sex  + (IBD=="CD"), data=.)
mod_sic_bl_uc = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="SWE") %>%
lm(value ~ age + sex  + (IBD=="UC"), data=.)
mod_hmp_bl_ibd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="USA") %>%
lm(value ~ age + sex + bmi + IBDy, data=.)
mod_hmp_bl_cd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="USA") %>%
lm(value ~ age + sex + bmi + (IBD=="CD"), data=.)
mod_hmp_bl_uc = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC"), country=="USA") %>%
lm(value ~ age + sex + bmi + (IBD=="UC"), data=.)
mod_hmp_f1_ibd = this_data %>% filter(phase=="F1", IBD %in% c("CD","UC","HC"), country=="USA") %>%
lm(value ~ age + sex  + bmi + IBDy, data=.)
mod_hmp_f1_cd = this_data %>% filter(phase=="F1", IBD %in% c("CD","UC","HC"), country=="USA") %>%
lm(value ~ age + sex  + bmi + (IBD=="CD"), data=.)
mod_hmp_f1_uc = this_data %>% filter(phase=="F1", IBD %in% c("CD","UC","HC"), country=="USA") %>%
lm(value ~ age + sex  + bmi + (IBD=="UC"), data=.)
mod_ibd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC")) %>%
lme(value ~ age + sex + IBDy, random = ~1|country, data=.)
mod_cd = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC")) %>%
lme(value ~ age + sex + (IBD=="CD"), random = ~1|country, data=.)
mod_uc = this_data %>% filter(phase=="BL", IBD %in% c("CD","UC","HC")) %>%
lme(value ~ age + sex + (IBD=="UC"), random = ~1|country, data=.)
bind_rows(
(summary(mod_kin_bl_ibd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>% mutate(BIC=BIC(mod_kin_bl_ibd), loglik=logLik(mod_kin_bl_ibd) %>% as.numeric(), mod = "KINBL"),
(summary(mod_kin_bl_cd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>% mutate(BIC=BIC(mod_kin_bl_cd), loglik=logLik(mod_kin_bl_cd) %>% as.numeric(), mod = "KINBL"),
(summary(mod_kin_bl_uc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>% mutate(BIC=BIC(mod_kin_bl_uc), loglik=logLik(mod_kin_bl_uc) %>% as.numeric(), mod = "KINBL"),
(summary(mod_kin_f1_ibd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>% mutate(BIC=BIC(mod_kin_f1_ibd), loglik=logLik(mod_kin_f1_ibd) %>% as.numeric(), mod = "KINF1"),
(summary(mod_kin_f1_cd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>% mutate(BIC=BIC(mod_kin_f1_cd), loglik=logLik(mod_kin_f1_cd) %>% as.numeric(), mod = "KINF1"),
(summary(mod_kin_f1_uc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>% mutate(BIC=BIC(mod_kin_f1_uc), loglik=logLik(mod_kin_f1_uc) %>% as.numeric(), mod = "KINF1"),
(summary(mod_itm_bl_ibd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_itm_bl_ibd), loglik=logLik(mod_itm_bl_ibd) %>% as.numeric(), mod = "ITMBL"),
(summary(mod_itm_bl_cd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_itm_bl_cd), loglik=logLik(mod_itm_bl_cd) %>% as.numeric(), mod = "ITMBL"),
(summary(mod_itm_bl_uc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_itm_bl_uc), loglik=logLik(mod_itm_bl_uc) %>% as.numeric(), mod = "ITMBL"),
(summary(mod_sic_bl_ibd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[4,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC((mod_sic_bl_ibd)), loglik=logLik(mod_sic_bl_ibd) %>% as.numeric(), mod = "SICBL"),
(summary(mod_sic_bl_cd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[4,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_sic_bl_cd), loglik=logLik(mod_sic_bl_cd) %>% as.numeric(), mod = "SICBL"),
(summary(mod_sic_bl_uc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[4,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_sic_bl_uc), loglik=logLik(mod_sic_bl_uc) %>% as.numeric(), mod = "SICBL"),
(summary(mod_hmp_bl_ibd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC((mod_hmp_bl_ibd)), loglik=logLik(mod_hmp_bl_ibd) %>% as.numeric(), mod = "HMPBL"),
(summary(mod_hmp_bl_cd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_hmp_bl_cd), loglik=logLik(mod_hmp_bl_cd) %>% as.numeric(), mod = "HMPBL"),
(summary(mod_hmp_bl_uc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_hmp_bl_uc), loglik=logLik(mod_hmp_bl_uc) %>% as.numeric(), mod = "HMPBL"),
(summary(mod_hmp_f1_ibd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC((mod_hmp_f1_ibd)), loglik=logLik(mod_hmp_f1_ibd) %>% as.numeric(), mod = "HMPF1"),
(summary(mod_hmp_f1_cd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_hmp_f1_cd), loglik=logLik(mod_hmp_f1_cd) %>% as.numeric(), mod = "HMPF1"),
(summary(mod_hmp_f1_uc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[5,] %>%dplyr::select(comp, Value=Estimate, Std.Error=Std..Error, t.value, p.value=Pr...t..) %>%
mutate(BIC=BIC(mod_hmp_f1_uc), loglik=logLik(mod_hmp_f1_uc) %>% as.numeric(), mod = "HMPF1"),
(summary(mod_ibd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[4,] %>% mutate(BIC=BIC(mod_ibd), loglik=logLik(mod_ibd) %>% as.numeric(), mod = "ALLBL"),
(summary(mod_cd) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[4,] %>% mutate(BIC=BIC(mod_cd), loglik=logLik(mod_cd) %>% as.numeric(), mod = "ALLBL"),
(summary(mod_uc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[4,] %>% mutate(BIC=BIC(mod_uc), loglik=logLik(mod_uc) %>% as.numeric(), mod = "ALLBL")
) %>% mutate(tax=g) %>% return(.)
}) %>% do.call("bind_rows",. )
pwy_res = pwy_res_raw %>% ungroup() %>% mutate(disease = case_when(grepl("IBDy",comp) ~ "IBD", grepl("CD",comp) ~ "CD", grepl("UC",comp) ~ "UC")) %>% group_by(mod) %>%
mutate(analysis=case_when(mod %in% c("HMPBL","ITMBL","SICBL") ~ "Primary", mod %in% c("KINF1","KINBL","HMPF1") ~ "Secondary", mod == "ALLBL" ~ "PrimaryMM")) %>%
group_by(mod) %>% mutate(p_adj = ifelse(mod == "ALLBL", p.adjust(p.value, "fdr"), p.adjust(p.value, "bonferroni"))) %>% ungroup() %>%
mutate(mod = factor(mod, levels=c("KINBL","KINF1","ITMBL","HMPBL","HMPF1","SICBL","ALLBL"))) %>%
mutate(analysis = factor(analysis, levels=c("Primary","Secondary","PrimaryMM")))
pwy_res_full = pwy_res %>% filter(!is.na(t.value)) %>%
(function(df) df %>% filter(mod=="ALLBL") %>% arrange(-loglik) %>% filter(!duplicated(tax)) %>% mutate(cat=ifelse(p_adj < 0.05, disease, "none"), dir=ifelse(Value>0,"UP","DOWN")) %>% dplyr::select(tax, cat, dir) %>% left_join(df, .) ) %>%
dplyr::select(tax, mod, disease, test_stat = t.value, beta = Value, se = Std.Error, BIC,loglik, p.value, q.value=p_adj, analysis, cat, dir)
pwy_res_meta = pwy_res_full %>% filter(!is.na(beta)) %>% mutate(w = 1 / se^2) %>% mutate(beta_w = beta * w) %>% filter(mod %in% c("ITMBL","SICBL","HMPBL")) %>%
group_by(tax, disease,cat) %>% summarise(beta_w_sum = sum(beta_w), w_sum = sum(w), se = sqrt(1/w_sum)) %>%
mutate(beta = beta_w_sum / w_sum, Z = beta / se) %>% mutate(p_meta = 2*pnorm(-abs(Z))) %>% ungroup() %>%
mutate(q_meta = p.adjust(p_meta, "fdr"), mod="META", analysis = "Meta Analysis") %>%
dplyr::select(tax, mod, disease, test_stat=Z, beta, se, p.value=p_meta, q.value = q_meta, analysis, cat) %>% ungroup() %>%
left_join(pwy_res %>% filter(mod=="ALLBL") %>% arrange(-loglik) %>% filter(!duplicated(tax)) %>% mutate(cat=ifelse(p_adj < 0.05, disease, "none"), dir=ifelse(Value>0,"UP","DOWN")) %>% dplyr::select(tax, cat, dir))
pwy_res_all = bind_rows(pwy_res_full, pwy_res_meta) %>%
mutate(res = factor(paste(q.value < 0.05, mod), levels = expand_grid(c(T,F),  c(as.character(unique(pwy_res$mod)),"META")) %>% apply(.,1,paste, collapse=" ")))
pwy_res_main = pwy_res_all %>%
mutate(country = case_when(grepl("ITM|KIN",mod) ~ "GER", grepl("HMP",mod) ~ "USA", grepl("SIC",mod) ~ "SWE", grepl("ALL|META",mod) ~ "ALL")) %>%
mutate(dir = factor(dir, levels=c("UP","DOWN"))) %>%
filter(cat==disease, analysis %in% c("Meta Analysis","Primary")) %>%
ggplot(aes(y=factor(tax, levels=(pwy_res_meta %>% arrange(-abs(beta)) %>% filter(analysis=="Meta Analysis") %>% filter(!duplicated(tax)) %>% arrange(beta) %>% pull(tax))), x=beta, col=disease, fill=ifelse(q.value<0.05, disease,"NA"), shape=country)) +
geom_vline(xintercept = 0) +
geom_point(size=3) +
scale_color_manual(values=colset$colors, breaks=colset$IBD) +
scale_fill_manual(values=c(colset$colors, "#FFFFFF00"), breaks=c(colset$IBD, "NA")) +
scale_shape_manual(values=c(21,24,22,23), breaks=c("GER","SWE","USA","ALL")) +
guides(color = guide_legend(override.aes = list(shape=16, size=5)), fill=guide_none()) +
facet_grid(cat ~ 1, scales="free", space="free_y") + ylab("pwyus")
pwy_res_main_p1 = pwy_res_all %>%
mutate(country = case_when(grepl("ITM|KIN",mod) ~ "GER", grepl("HMP",mod) ~ "USA", grepl("SIC",mod) ~ "SWE", grepl("ALL|META",mod) ~ "ALL")) %>%
mutate(dir = factor(dir, levels=c("UP","DOWN"))) %>%
filter(cat==disease, analysis %in% c("Meta Analysis","Primary")) %>%
filter(cat %in% c("IBD","UC")) %>%
ggplot(aes(y=factor(tax, levels=(pwy_res_meta %>% arrange(-abs(beta)) %>% filter(analysis=="Meta Analysis", cat==disease) %>% filter(!duplicated(tax)) %>% arrange(beta) %>% pull(tax))), x=beta, col=disease, fill=ifelse(q.value<0.05, disease,"NA"), shape=country)) +
geom_vline(xintercept = 0) +
geom_point(aes(size=country=="ALL")) +
scale_color_manual(values=colset$colors, breaks=colset$IBD) +
scale_fill_manual(values=c(colset$colors, "#FFFFFF00"), breaks=c(colset$IBD, "NA")) +
scale_shape_manual(values=c(21,24,22,23), breaks=c("GER","SWE","USA","ALL")) +
scale_size_manual(values=c(2,4), breaks=c(F,T)) +
guides(fill = guide_legend(override.aes = list(shape=21, size=5))) +
facet_grid(cat ~ 1, scales="free", space="free_y") + ylab("pwyus") + xlab("Effect Size")
pwy_res_main_p2 = pwy_res_all %>%
mutate(country = case_when(grepl("ITM|KIN",mod) ~ "GER", grepl("HMP",mod) ~ "USA", grepl("SIC",mod) ~ "SWE", grepl("ALL|META",mod) ~ "ALL")) %>%
mutate(dir = factor(dir, levels=c("UP","DOWN"))) %>%
filter(cat==disease, analysis %in% c("Meta Analysis","Primary")) %>%
filter(cat %in% c("CD")) %>%
ggplot(aes(y=factor(tax, levels=(pwy_res_meta %>% arrange(-abs(beta)) %>% filter(analysis=="Meta Analysis", cat==disease) %>% filter(!duplicated(tax)) %>% arrange(beta) %>% pull(tax))), x=beta, col=disease, fill=ifelse(q.value<0.05, disease,"NA"), shape=country)) +
geom_vline(xintercept = 0) +
geom_point(aes(size=country=="ALL")) +
scale_color_manual(values=colset$colors, breaks=colset$IBD) +
scale_fill_manual(values=c(colset$colors, "#FFFFFF00"), breaks=c(colset$IBD, "NA")) +
scale_shape_manual(values=c(21,24,22,23), breaks=c("GER","SWE","USA","ALL")) +
scale_size_manual(values=c(2,4), breaks=c(F,T)) +
guides(fill = guide_legend(override.aes = list(shape=21, size=5))) +
facet_grid(cat ~ 1, scales="free", space="free_y") + ylab("pwyus") + xlab("Effect Size")
pwy_res_main_2 = cowplot::plot_grid(
cowplot::plot_grid(pwy_res_main_p1+ theme(legend.position = "none"), cowplot::get_legend(pwy_res_main + theme(legend.position = "right", legend.direction = "horizontal")), rel_heights = c(.85,.15), ncol=1 ),
pwy_res_main_p2 + theme(legend.position = "none"))
pwy_res_main_2
pwy_res_main_p1_top10 = pwy_res_all %>%
left_join(pwy_names, by=c("tax"="ID")) %>%
mutate(lab = paste0(tax,": ",Name)) %>%
mutate(country = case_when(grepl("ITM|KIN",mod) ~ "GER", grepl("HMP",mod) ~ "USA", grepl("SIC",mod) ~ "SWE", grepl("ALL|META",mod) ~ "ALL")) %>%
mutate(dir = factor(dir, levels=c("UP","DOWN"))) %>%
filter(cat==disease, analysis %in% c("Meta Analysis","Primary")) %>%
filter(cat %in% c("CD")) %>%
mutate(lab=factor(lab, levels=(pwy_res_meta %>% left_join(pwy_names, by=c("tax"="ID")) %>% mutate(lab = paste0(tax,": ",Name)) %>% arrange(-abs(beta)) %>% filter(analysis=="Meta Analysis", cat==disease) %>% filter(!duplicated(tax)) %>% arrange(beta) %>% pull(lab)))) %>%
(function(df) df %>% filter(tax %in% c(df %>% group_by(cat) %>% filter(analysis=="Meta Analysis", beta>0) %>% slice_max(order_by = beta, n=10) %>% pull(tax),df %>% group_by(cat) %>% filter(analysis=="Meta Analysis", beta<0) %>% slice_min(order_by = beta, n=10) %>% pull(tax)))) %>%
ggplot(aes(y=lab, x=beta, col=disease, fill=ifelse(q.value<0.05, disease,"NA"), shape=country)) +
geom_vline(xintercept = 0) +
geom_point(aes(size=country=="ALL")) +
scale_color_manual(values=colset$colors, breaks=colset$IBD) +
scale_fill_manual(values=c(colset$colors, "#FFFFFF00"), breaks=c(colset$IBD, "NA")) +
scale_shape_manual(values=c(21,24,22,23), breaks=c("GER","SWE","USA","ALL")) +
scale_size_manual(values=c(2,4), breaks=c(F,T)) +
guides(fill = guide_legend(override.aes = list(shape=21, size=5))) +
ylab("Pathway") + xlab("Effect Size")
pwy_res_main_p2_top10 = pwy_res_all %>%
left_join(pwy_names, by=c("tax"="ID")) %>%
mutate(lab = paste0(tax,": ",Name)) %>%
mutate(country = case_when(grepl("ITM|KIN",mod) ~ "GER", grepl("HMP",mod) ~ "USA", grepl("SIC",mod) ~ "SWE", grepl("ALL|META",mod) ~ "ALL")) %>%
mutate(dir = factor(dir, levels=c("UP","DOWN"))) %>%
filter(cat==disease, analysis %in% c("Meta Analysis","Primary")) %>%
filter(cat %in% c("UC")) %>%
mutate(lab=factor(lab, levels=(pwy_res_meta %>% left_join(pwy_names, by=c("tax"="ID")) %>% mutate(lab = paste0(tax,": ",Name)) %>% arrange(-abs(beta)) %>% filter(analysis=="Meta Analysis", cat==disease) %>% filter(!duplicated(tax)) %>% arrange(beta) %>% pull(lab)))) %>%
(function(df) df %>% filter(tax %in% c(df %>% group_by(cat) %>% filter(analysis=="Meta Analysis", beta>0) %>% slice_max(order_by = beta, n=10) %>% pull(tax),df %>% group_by(cat) %>% filter(analysis=="Meta Analysis", beta<0) %>% slice_min(order_by = beta, n=16) %>% pull(tax)))) %>%
ggplot(aes(y=lab, x=beta, col=disease, fill=ifelse(q.value<0.05, disease,"NA"), shape=country)) +
geom_vline(xintercept = 0) +
geom_point(aes(size=country=="ALL")) +
scale_color_manual(values=colset$colors, breaks=colset$IBD) +
scale_fill_manual(values=c(colset$colors, "#FFFFFF00"), breaks=c(colset$IBD, "NA")) +
scale_shape_manual(values=c(21,24,22,23), breaks=c("GER","SWE","USA","ALL")) +
scale_size_manual(values=c(2,4), breaks=c(F,T)) +
guides(fill = guide_legend(override.aes = list(shape=21, size=5))) +
ylab("Pathway") + xlab("Effect Size")
pwy_res_main_p3_top10 = pwy_res_all %>%
left_join(pwy_names, by=c("tax"="ID")) %>%
mutate(lab = paste0(tax,": ",Name)) %>%
mutate(country = case_when(grepl("ITM|KIN",mod) ~ "GER", grepl("HMP",mod) ~ "USA", grepl("SIC",mod) ~ "SWE", grepl("ALL|META",mod) ~ "ALL")) %>%
mutate(dir = factor(dir, levels=c("UP","DOWN"))) %>%
filter(cat==disease, analysis %in% c("Meta Analysis","Primary")) %>%
filter(cat %in% c("IBD")) %>%
mutate(lab=factor(lab, levels=(pwy_res_meta %>% left_join(pwy_names, by=c("tax"="ID")) %>% mutate(lab = paste0(tax,": ",Name)) %>% arrange(-abs(beta)) %>% filter(analysis=="Meta Analysis", cat==disease) %>% filter(!duplicated(tax)) %>% arrange(beta) %>% pull(lab)))) %>%
(function(df) df %>% filter(tax %in% c(df %>% group_by(cat) %>% filter(analysis=="Meta Analysis", beta>0) %>% slice_max(order_by = beta, n=10) %>% pull(tax),df %>% group_by(cat) %>% filter(analysis=="Meta Analysis", beta<0) %>% slice_min(order_by = beta, n=10) %>% pull(tax)))) %>%
ggplot(aes(y=lab, x=beta, col=disease, fill=ifelse(q.value<0.05, disease,"NA"), shape=country)) +
geom_vline(xintercept = 0) +
geom_point(aes(size=country=="ALL")) +
scale_color_manual(values=colset$colors, breaks=colset$IBD) +
scale_fill_manual(values=c(colset$colors, "#FFFFFF00"), breaks=c(colset$IBD, "NA")) +
scale_shape_manual(values=c(21,24,22,23), breaks=c("GER","SWE","USA","ALL")) +
scale_size_manual(values=c(2,4), breaks=c(F,T)) +
guides(fill = guide_legend(override.aes = list(shape=21, size=5))) +
ylab("Pathway") + xlab("Effect Size")
pwy_res_main_3 =
cowplot::plot_grid(
cowplot::plot_grid(pwy_res_main_p1_top10+ theme(legend.position = "none"), pwy_res_main_p2_top10+ theme(legend.position = "none"),  rel_heights = c(.5,.5), ncol=1),
cowplot::plot_grid(pwy_res_main_p3_top10 + theme(legend.position = "none"), cowplot::get_legend(pwy_res_main + theme(legend.position = "right", legend.direction = "horizontal")), rel_heights = c(.5,.5), ncol=1 )
)
pwy_res_main_3
cowplot::plot_grid(
cowplot::plot_grid(cmd_unir_p2c, cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=("B","C")), ncol=1, labels=c("A","")), plot_spe_hilo, labels=c("","D"))
cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=("B","C"))
cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=("B","C"))
cowplot::plot_grid(labels = )
cowplot::plot_grid(
cowplot::plot_grid(cmd_unir_p2c, cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=("B","C")), ncol=1, labels=c("A","")), plot_spe_hilo, labels=c("","D"))
cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=("B","C"))
cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk
cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk)
cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=c())
cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=c("B","C"))
cowplot::plot_grid(
cowplot::plot_grid(cmd_unir_p2c, cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=c("B","C")), ncol=1, labels=c("A","")), plot_spe_hilo, labels=c("","D"))
plot_spe_hilo = spe_res_fc %>%
filter(tax %in% (spe_res_fc %>% filter(mod %in% c("FCHILO","FCUCCD"), p_adj < 0.1) %>% pull(tax))) %>%
filter(p_adj < 0.1) %>%
ggplot(aes(x=abs(Estimate),
y=factor(tax, levels = spe_res_fc %>% filter() %>% arrange(tax, Estimate) %>% filter(!duplicated(tax)) %>% arrange(Estimate) %>% pull(tax))
)) +
geom_point(aes(col=mod,
fill=ifelse(p_adj < 0.05,mod,"X"),
shape = sign(Estimate)==1, size=3)) +
## add IBD association
geom_point(
data = spe_res_all %>% mutate(tax=as.character(tax)) %>% filter(analysis=="Meta Analysis",
tax %in% (spe_res_fc %>% filter(mod %in% c("FCHILO","FCUCCD"), p_adj < 0.1) %>% pull(tax))) %>%
filter(cat==disease, q.value < 0.05) %>%
dplyr::select(g=tax, Estimate=beta, disease, p.adj = q.value) ,
aes(fill=disease,
x=3,
shape=sign(Estimate)==1,
size=3,
y=g), col="black", size=3) +
scale_shape_manual(values=c(25,24)) +
scale_color_manual(values=c(colset$colors,"#549ac8","#df3b2a","#c9e8ff"), breaks=c(colset$IBD, "FCHILO","FCUCCD","HCHI")  ) +
scale_fill_manual(values=c(colset$colors,"#549ac8","#df3b2a","#c9e8ff", "#FFFFFF00"), breaks=c(colset$IBD, "FCHILO","FCUCCD","HCHI","X")  ) +
scale_x_continuous(limits=c(0,3.5), breaks=c(0:3), labels = c(0:2,"IBD"), minor_breaks = NULL, expand=c(0,0)) +
geom_vline(xintercept = 2.5, linewidth=1) + ylab("Taxon") + xlab("| Effect Size |") +
theme(legend.position = "none")
spe_abu_long = spe_clr %>% reshape2::melt(.) %>% dplyr::select(-set) %>%
left_join(spe %>% reshape2::melt(.) %>%dplyr::select(sample, variable, value_tpm = value)) %>%
left_join(meta_minimal, by="sample") %>%
mutate(variable=as.character(variable)) %>%
mutate(IBDy= IBD %in% c("CD","UC"), IBD_CD = IBD=="CD")
spe_res_fc = lapply(testvars_spe, function(g){
this_data = spe_abu_long %>% filter(variable==g, ! IBD %in% c("CD","UC"), country=="GER" , phase=="BL")
### KIN BL
mod_fc = this_data %>% filter(IBD!="HC") %>%
lmerTest::lmer(value ~  bmi + (IBD_r=="FC High") + (1|family), data=.)
mod_fcfam = this_data %>% filter(IBD!="HC") %>%
lmerTest::lmer(value ~  bmi + (ibd_fam=="FC CD") + (1|family), data=.)
mod_hc = this_data %>% filter(IBD!="FC Low", phase=="BL") %>%
lm(value ~ bmi + (IBD_r=="FC High"), data=.)
bind_rows(
(summary(mod_fc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[3,] %>% mutate(BIC=BIC(mod_fc),loglik=logLik(mod_fc) %>% as.numeric(), mod = "FCHILO"),
(summary(mod_fcfam) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[3,] %>% mutate(BIC=BIC(mod_fcfam),loglik=logLik(mod_fcfam) %>% as.numeric(), mod = "FCUCCD"),
(summary(mod_hc) %>% coefficients() %>% data.frame() %>% rownames_to_column("comp"))[3,] %>% mutate(BIC=BIC(mod_hc),loglik=logLik(mod_hc) %>% as.numeric(), mod = "HCHI")
) %>% mutate(tax=g) %>% return(.)
}) %>% do.call("bind_rows",. )  %>% group_by(mod) %>% mutate(p_adj = p.adjust(Pr...t.., "fdr"))  %>% ungroup()
plot_spe_hilo = spe_res_fc %>%
filter(tax %in% (spe_res_fc %>% filter(mod %in% c("FCHILO","FCUCCD"), p_adj < 0.1) %>% pull(tax))) %>%
filter(p_adj < 0.1) %>%
ggplot(aes(x=abs(Estimate),
y=factor(tax, levels = spe_res_fc %>% filter() %>% arrange(tax, Estimate) %>% filter(!duplicated(tax)) %>% arrange(Estimate) %>% pull(tax))
)) +
geom_point(aes(col=mod,
fill=ifelse(p_adj < 0.05,mod,"X"),
shape = sign(Estimate)==1, size=3)) +
## add IBD association
geom_point(
data = spe_res_all %>% mutate(tax=as.character(tax)) %>% filter(analysis=="Meta Analysis",
tax %in% (spe_res_fc %>% filter(mod %in% c("FCHILO","FCUCCD"), p_adj < 0.1) %>% pull(tax))) %>%
filter(cat==disease, q.value < 0.05) %>%
dplyr::select(g=tax, Estimate=beta, disease, p.adj = q.value) ,
aes(fill=disease,
x=3,
shape=sign(Estimate)==1,
size=3,
y=g), col="black", size=3) +
scale_shape_manual(values=c(25,24)) +
scale_color_manual(values=c(colset$colors,"#549ac8","#df3b2a","#c9e8ff"), breaks=c(colset$IBD, "FCHILO","FCUCCD","HCHI")  ) +
scale_fill_manual(values=c(colset$colors,"#549ac8","#df3b2a","#c9e8ff", "#FFFFFF00"), breaks=c(colset$IBD, "FCHILO","FCUCCD","HCHI","X")  ) +
scale_x_continuous(limits=c(0,3.5), breaks=c(0:3), labels = c(0:2,"IBD"), minor_breaks = NULL, expand=c(0,0)) +
geom_vline(xintercept = 2.5, linewidth=1) + ylab("Taxon") + xlab("| Effect Size |") +
theme(legend.position = "none")
cowplot::plot_grid(
cowplot::plot_grid(cmd_unir_p2c, cowplot::plot_grid(alpha_plot_gerbl_fcfam, alpha_plot_gerbl_fcrisk, labels=c("B","C")), ncol=1, labels=c("A","")), plot_spe_hilo, labels=c("","D"))
ggsave("Figure2_draft.pdf", width=10, height=5)
alpha_plot_gerbl_fcfam
alpha_plot_gerbl_fcfam$data
alpha_plot_gerbl_fcfam$data %>% lm(PD ~ age + sex + bmi + IBD_r)
alpha_plot_gerbl_fcfam$data %>% lm(PD ~ age + sex + bmi + IBD_r, datat=.)
lm(PD ~ age + sex + bmi + IBD_r, datat=alpha_plot_gerbl_fcfam$data)
lm(PD ~ age + sex + bmi + IBD_r, data=alpha_plot_gerbl_fcfam$data)
lm(PD ~ age + sex + bmi + IBD_r, data=alpha_plot_gerbl_fcfam$data) %>% summary
lm(PD ~ sex + bmi + IBD_r, data=alpha_plot_gerbl_fcfam$data) %>% summary
adonis2(aitch_unir_fc ~ IBD_r, data=meta_minimal %>% filter(IBD=="FC", phase=="BL") %>% column_to_rownames("sample"))
adonis2(aitch_unir_fc ~ ibd_fam, data=meta_minimal %>% filter(IBD=="FC", phase=="BL") %>% column_to_rownames("sample"))
adonis2(aitch_unir_fc ~ IBD_r, data=meta_minimal %>% filter(IBD=="FC", phase=="BL") %>% column_to_rownames("sample"), permutations = 9999)
adonis2(aitch_unir_fc ~ IBD_r, data=meta_minimal %>% filter(IBD=="FC", phase=="BL") %>% column_to_rownames("sample"))
adonis2(aitch_unir_fc ~ IBD_r, data=meta_minimal %>% filter(IBD=="FC", phase=="BL") %>% column_to_rownames("sample"))
curatedMetagenomicData()
sampleMetadata
sampleMetadata$country
sampleMetadata$country %>% table()
sampleMetadata %>% filter(country=="NLD")
sampleMetadata %>% filter(country=="NLD") %>% view
sampleMetadata %>% filter(country=="LifeLinesDeep_2016")
sampleMetadata %>% filter(study_name=="LifeLinesDeep_2016")
sampleMetadata %>% filter(study_name=="LifeLinesDeep_2016") %>% summary
sampleMetadata %>% filter(study_name=="LifeLinesDeep_2016") %>% view
